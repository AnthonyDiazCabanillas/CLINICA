³
SD:\CLINICA\nsp-csfl-agenda-uti-automatizacion_qa\GeneracionReporteDietas\Program.cs
	namespace 	#
GeneracionReporteDietas
 !
{ 
class 
Program 
{ 
private 	
static
 
IConfiguration 
_configuration  .
;. /
private 	
static
 
ILogger 
_logger  
;  !
static 
void	 
Main 
( 
string 
[ 
] 
args  
)  !
{ 
ConfigureServices 
( 
) 
; 
try 
{ 
_logger 
. 
LogInformation 
( 
$str /
)/ 0
;0 1
string 

connectionString 
= 
_configuration ,
., -
GetConnectionString- @
(@ A
$strA T
)T U
;U V
string 

sharedFolderPath 
= 
_configuration ,
[, -
$str- ?
]? @
;@ A
var!! 
	tableHtml!! 
=!! !
FetchDataFromDatabase!! )
(!!) *
connectionString!!* :
)!!: ;
;!!; <
string"" 

shift"" 
="" 
DetermineShift"" !
(""! "
)""" #
;""# $
var## 
pdfPath## 
=## 
GeneratePdf## 
(## 
	tableHtml## '
,##' (
sharedFolderPath##) 9
,##9 :
shift##; @
)##@ A
;##A B
SendEmailWithPdf$$ 
($$ 
connectionString$$ %
,$$% &
pdfPath$$' .
)$$. /
;$$/ 0
File%% 
.%% 	
Delete%%	 
(%% 
pdfPath%% 
)%% 
;%% 
_logger&& 
.&& 
LogInformation&& 
(&& 
$str&& ,
)&&, -
;&&- .
}'' 
catch(( 
(((	 

	Exception((
 
ex(( 
)(( 
{)) 
_logger** 
.** 
LogError** 
(** 
ex** 
,** 
$str** N
)**N O
;**O P
}++ 
},, 
private.. 	
static..
 
string.. !
FetchDataFromDatabase.. -
(..- .
string... 4
connectionString..5 E
)..E F
{// 
string00 	
storedProcedure00
 
=00 
$str00 3
;003 4
var11 
	tableHtml11 
=11 
$str11 
;11 
using33 
(33	 

var33
 

connection33 
=33 
new33 
SqlConnection33 ,
(33, -
connectionString33- =
)33= >
)33> ?
{44 
try55 
{66 

connection77 
.77 
Open77 
(77 
)77 
;77 
using88 

(88 
var88 
command88 
=88 
new88 

SqlCommand88 (
(88( )
storedProcedure88) 8
,888 9

connection88: D
)88D E
)88E F
{99 
command:: 
.:: 
CommandType:: 
=:: 
CommandType:: '
.::' (
StoredProcedure::( 7
;::7 8
using;; 
(;; 
var;; 
reader;; 
=;; 
command;; !
.;;! "
ExecuteReader;;" /
(;;/ 0
);;0 1
);;1 2
{<< 
while== 
(== 
reader== 
.== 
Read== 
(== 
)== 
)== 
{>> 
	tableHtml?? 
+=?? 
$str?? 
;?? 
for@@ 
(@@ 
int@@ 
i@@ 
=@@ 
$num@@ 
;@@ 
i@@ 
<@@ 
reader@@ "
.@@" #

FieldCount@@# -
;@@- .
i@@/ 0
++@@0 2
)@@2 3
{AA 	
ifBB	 
(BB 
iBB 
==BB 
$numBB 
)BB 
continueBB 
;BB 
	tableHtmlCC	 
+=CC 
$strCC 
+CC 
readerCC %
[CC% &
iCC& '
]CC' (
.CC( )
ToStringCC) 1
(CC1 2
)CC2 3
+CC4 5
$strCC6 =
;CC= >
}DD 	
	tableHtmlEE 
+=EE 
$strEE 
;EE 
}FF 
}GG 
}HH 
}II 
catchJJ 	
(JJ
 
SqlExceptionJJ 
exJJ 
)JJ 
{KK 
_loggerLL 
.LL 
LogErrorLL 
(LL 
exLL 
,LL 
$strLL G
)LLG H
;LLH I
throwMM 

;MM
 
}NN 
}OO 
returnQQ 	
	tableHtmlQQ
 
;QQ 
}RR 
privateTT 	
staticTT
 
stringTT 
GeneratePdfTT #
(TT# $
stringTT$ *
	tableHtmlTT+ 4
,TT4 5
stringTT6 <
sharedFolderPathTT= M
,TTM N
stringTTO U
shiftTTV [
)TT[ \
{UU 
varVV 
guidVV 
=VV 
GuidVV 
.VV 
NewGuidVV 
(VV 
)VV 
;VV 
stringWW 	
pdfPathWW
 
=WW 
PathWW 
.WW 
CombineWW  
(WW  !
sharedFolderPathWW! 1
,WW1 2
$strWW3 B
+WWC D
guidWWE I
+WWJ K
$strWWL R
)WWR S
;WWS T
tryYY 
{ZZ 
string[[ 


htmlString[[ 
=[[ 
$str[[  
+[[! "
$str\\ 
+\\ 
$str]] 
+]] 
$str^^ 
+^^ 
$str__ !
+__" #
$str`` "
+``# $
$straa !
+aa" #
$strbb 
+bb 
$strcc 
+cc 
$strdd  
+dd! "
$stree .
+ee/ 0
$strff (
+ff) *
$strgg 
+gg 
$strhh 
+hh 
$strii .
+ii/ 0
$strjj !
+jj" #
$strkk 
+kk 
$strll 
+ll 
$strmm ,
+mm- .
$strnn !
+nn" #
$stroo %
+oo& '
$strpp *
+pp+ ,
$strqq 
+qq 
$strrr 
+rr 
$strss "
+ss# $
$strtt 
+tt  !
$struu 
+uu 
$strvv 
+vv 
$strww 
+ww  !
$strxx 
+xx 
$stryy 
+yy  
$strzz '
+zz( )
$str{{ $
+{{% &
$str|| %
+||& '
$str}} (
+}}) *
$str~~ 
+~~ 
$str 
+ 
$str
€€ 
+
€€ 
$str
 
+
 
$str
‚‚ G
+
‚‚H I
DateTime
‚‚J R
.
‚‚R S
Now
‚‚S V
.
‚‚V W
ToString
‚‚W _
(
‚‚_ `
$str
‚‚` c
)
‚‚c d
+
‚‚e f
$str
‚‚g j
+
‚‚k l
shift
‚‚m r
+
‚‚s t
$str
‚‚u }
+
‚‚~ 
$str
ƒƒ 
+
ƒƒ 
$str
„„ !
+
„„" #
$str
…… 9
+
……: ;
$str
†† 8
+
††9 :
$str
‡‡ I
+
‡‡J K
$str
ˆˆ 9
+
ˆˆ: ;
$str
‰‰ :
+
‰‰; <
$str
ŠŠ :
+
ŠŠ; <
$str
‹‹ !
+
‹‹" #
$str
ŒŒ +
+
ŒŒ, -
$str
 3
+
4 5
$str
ŽŽ J
+
ŽŽK L
$str
 $
+
% &
	tableHtml
' 0
+
1 2
$str
 
+
 
$str
‘‘ 
+
‘‘ 
$str
’’ 
;
’’ 
using
”” 	
(
””
 
	PdfWriter
”” 
writer
”” 
=
”” 
new
”” !
	PdfWriter
””" +
(
””+ ,
pdfPath
””, 3
)
””3 4
)
””4 5
{
•• 
using
–– 

(
–– 
PdfDocument
–– 
pdf
–– 
=
–– 
new
–– !
PdfDocument
––" -
(
––- .
writer
––. 4
)
––4 5
)
––5 6
{
—— 
pdf
˜˜ 	
.
˜˜	 
 
SetDefaultPageSize
˜˜
 
(
˜˜ 
iText
˜˜ "
.
˜˜" #
Kernel
˜˜# )
.
˜˜) *
Geom
˜˜* .
.
˜˜. /
PageSize
˜˜/ 7
.
˜˜7 8
A4
˜˜8 :
.
˜˜: ;
Rotate
˜˜; A
(
˜˜A B
)
˜˜B C
)
˜˜C D
;
˜˜D E!
ConverterProperties
™™ 

properties
™™ $
=
™™% &
new
™™' *!
ConverterProperties
™™+ >
(
™™> ?
)
™™? @
;
™™@ A
HtmlConverter
šš 
.
šš 
ConvertToPdf
šš  
(
šš  !

htmlString
šš! +
,
šš+ ,
pdf
šš- 0
,
šš0 1

properties
šš2 <
)
šš< =
;
šš= >
}
›› 
}
œœ 
}
 
catch
žž 
(
žž	 

	Exception
žž
 
ex
žž 
)
žž 
{
ŸŸ 
_logger
   
.
   
LogError
   
(
   
ex
   
,
   
$str
   3
)
  3 4
;
  4 5
throw
¡¡ 	
;
¡¡	 

}
¢¢ 
return
¤¤ 	
pdfPath
¤¤
 
;
¤¤ 
}
¥¥ 
private
§§ 	
static
§§
 
void
§§ 
SendEmailWithPdf
§§ &
(
§§& '
string
§§' -
connectionString
§§. >
,
§§> ?
string
§§@ F
pdfPath
§§G N
)
§§N O
{
¨¨ 
try
©© 
{
ªª 
using
«« 	
(
««
 
var
«« 

connection
«« 
=
«« 
new
«« 
SqlConnection
««  -
(
««- .
connectionString
««. >
)
««> ?
)
««? @
{
¬¬ 

connection
­­ 
.
­­ 
Open
­­ 
(
­­ 
)
­­ 
;
­­ 
using
®® 

(
®® 
var
®® 
command
®® 
=
®® 
new
®® 

SqlCommand
®® (
(
®®( )
$str
®®) E
,
®®E F

connection
®®G Q
)
®®Q R
)
®®R S
{
¯¯ 
command
°° 
.
°° 
CommandType
°° 
=
°° 
CommandType
°° '
.
°°' (
StoredProcedure
°°( 7
;
°°7 8
command
±± 
.
±± 

Parameters
±± 
.
±± 
AddWithValue
±± %
(
±±% &
$str
±±& .
,
±±. /
$num
±±0 1
)
±±1 2
;
±±2 3
command
²² 
.
²² 

Parameters
²² 
.
²² 
AddWithValue
²² %
(
²²% &
$str
²²& 4
,
²²4 5
Path
²²6 :
.
²²: ;)
GetFileNameWithoutExtension
²²; V
(
²²V W
pdfPath
²²W ^
)
²²^ _
)
²²_ `
;
²²` a
command
³³ 
.
³³ 
ExecuteNonQuery
³³ 
(
³³ 
)
³³ 
;
³³  
}
´´ 
}
µµ 
}
¶¶ 
catch
·· 
(
··	 

SqlException
··
 
ex
·· 
)
·· 
{
¸¸ 
_logger
¹¹ 
.
¹¹ 
LogError
¹¹ 
(
¹¹ 
ex
¹¹ 
,
¹¹ 
$str
¹¹ >
)
¹¹> ?
;
¹¹? @
throw
ºº 	
;
ºº	 

}
»» 
}
¼¼ 
private
¾¾ 	
static
¾¾
 
string
¾¾ 
DetermineShift
¾¾ &
(
¾¾& '
)
¾¾' (
{
¿¿ 
var
ÀÀ 
currentHour
ÀÀ 
=
ÀÀ 
DateTime
ÀÀ 
.
ÀÀ 
Now
ÀÀ !
.
ÀÀ! "
	TimeOfDay
ÀÀ" +
;
ÀÀ+ ,
if
ÁÁ 
(
ÁÁ 
currentHour
ÁÁ 
<
ÁÁ 
new
ÁÁ 
TimeSpan
ÁÁ !
(
ÁÁ! "
$num
ÁÁ" #
,
ÁÁ# $
$num
ÁÁ% &
,
ÁÁ& '
$num
ÁÁ( )
)
ÁÁ) *
)
ÁÁ* +
{
ÂÂ 
return
ÃÃ 

$str
ÃÃ 
;
ÃÃ 
}
ÄÄ 
else
ÅÅ 
if
ÅÅ 

(
ÅÅ 
currentHour
ÅÅ 
<
ÅÅ 
new
ÅÅ 
TimeSpan
ÅÅ &
(
ÅÅ& '
$num
ÅÅ' )
,
ÅÅ) *
$num
ÅÅ+ ,
,
ÅÅ, -
$num
ÅÅ. /
)
ÅÅ/ 0
)
ÅÅ0 1
{
ÆÆ 
return
ÇÇ 

$str
ÇÇ 
;
ÇÇ 
}
ÈÈ 
else
ÉÉ 
{
ÊÊ 
return
ËË 

$str
ËË 
;
ËË 
}
ÌÌ 
}
ÍÍ 
private
ÏÏ 	
static
ÏÏ
 
void
ÏÏ 
ConfigureServices
ÏÏ '
(
ÏÏ' (
)
ÏÏ( )
{
ÐÐ 
var
ÑÑ 
appDirectory
ÑÑ 
=
ÑÑ 
	AppDomain
ÑÑ 
.
ÑÑ  
CurrentDomain
ÑÑ  -
.
ÑÑ- .
BaseDirectory
ÑÑ. ;
;
ÑÑ; <
var
ÒÒ 
builder
ÒÒ 
=
ÒÒ 
new
ÒÒ "
ConfigurationBuilder
ÒÒ )
(
ÒÒ) *
)
ÒÒ* +
.
ÓÓ
 
SetBasePath
ÓÓ 
(
ÓÓ 
appDirectory
ÓÓ #
)
ÓÓ# $
.
ÔÔ
 
AddJsonFile
ÔÔ 
(
ÔÔ 
$str
ÔÔ )
,
ÔÔ) *
optional
ÔÔ+ 3
:
ÔÔ3 4
false
ÔÔ5 :
,
ÔÔ: ;
reloadOnChange
ÔÔ< J
:
ÔÔJ K
true
ÔÔL P
)
ÔÔP Q
;
ÔÔQ R
_configuration
ÕÕ 
=
ÕÕ 
builder
ÕÕ 
.
ÕÕ 
Build
ÕÕ !
(
ÕÕ! "
)
ÕÕ" #
;
ÕÕ# $
var
×× 
serviceCollection
×× 
=
×× 
new
×× 
ServiceCollection
×× 0
(
××0 1
)
××1 2
;
××2 3
serviceCollection
ØØ 
.
ØØ 

AddLogging
ØØ 
(
ØØ  
	configure
ØØ  )
=>
ØØ* ,
{
ÙÙ 
	configure
ÚÚ 
.
ÚÚ 
AddConfiguration
ÚÚ 
(
ÚÚ 
_configuration
ÚÚ -
.
ÚÚ- .

GetSection
ÚÚ. 8
(
ÚÚ8 9
$str
ÚÚ9 B
)
ÚÚB C
)
ÚÚC D
;
ÚÚD E
	configure
ÛÛ 
.
ÛÛ 

AddConsole
ÛÛ 
(
ÛÛ 
)
ÛÛ 
;
ÛÛ 
var
ÜÜ 
logFilePath
ÜÜ 
=
ÜÜ 
_configuration
ÜÜ $
[
ÜÜ$ %
$str
ÜÜ% 3
]
ÜÜ3 4
;
ÜÜ4 5
if
ÝÝ 
(
ÝÝ 
!
ÝÝ 	
string
ÝÝ	 
.
ÝÝ 
IsNullOrEmpty
ÝÝ 
(
ÝÝ 
logFilePath
ÝÝ )
)
ÝÝ) *
)
ÝÝ* +
{
ÞÞ 
	configure
ßß 
.
ßß 
AddProvider
ßß 
(
ßß 
new
ßß  
FileLoggerProvider
ßß 1
(
ßß1 2
logFilePath
ßß2 =
)
ßß= >
)
ßß> ?
;
ßß? @
}
àà 
}
áá 
)
áá 
;
áá 
var
ãã 
serviceProvider
ãã 
=
ãã 
serviceCollection
ãã *
.
ãã* +"
BuildServiceProvider
ãã+ ?
(
ãã? @
)
ãã@ A
;
ããA B
_logger
ää 

=
ää 
serviceProvider
ää 
.
ää 

GetService
ää '
<
ää' (
ILogger
ää( /
<
ää/ 0
Program
ää0 7
>
ää7 8
>
ää8 9
(
ää9 :
)
ää: ;
;
ää; <
}
åå 
}
ææ 
}çç ¾
^D:\CLINICA\nsp-csfl-agenda-uti-automatizacion_qa\GeneracionReporteDietas\FileLoggerProvider.cs
	namespace 	#
GeneracionReporteDietas
 !
{ 
public 
class 
FileLoggerProvider  
:! "
ILoggerProvider# 2
{ 
private 	
readonly
 
string 
path 
; 
public 
FileLoggerProvider	 
( 
string "
path# '
)' (
{		 
this

 
.

 
path

 
=

 
path

 
;

 
} 
public 
ILogger	 
CreateLogger 
( 
string $
categoryName% 1
)1 2
{ 
return 	
new
 

FileLogger 
( 
path 
) 
; 
} 
public 
void	 
Dispose 
( 
) 
{ 
} 
} 
} Ç
VD:\CLINICA\nsp-csfl-agenda-uti-automatizacion_qa\GeneracionReporteDietas\FileLogger.cs
	namespace 	#
GeneracionReporteDietas
 !
{ 
public 
class 

FileLogger 
: 
ILogger "
{ 
private 	
readonly
 
string 
filePath "
;" #
public

 

FileLogger

	 
(

 
string

 
path

 
)

  
{ 
filePath 
= 
path 
; 
} 
public 
IDisposable	 

BeginScope 
<  
TState  &
>& '
(' (
TState( .
state/ 4
)4 5
=>6 8
null9 =
;= >
public 
bool	 
	IsEnabled 
( 
LogLevel  
logLevel! )
)) *
=>+ -
true. 2
;2 3
public 
void	 
Log 
< 
TState 
> 
( 
LogLevel "
logLevel# +
,+ ,
EventId- 4
eventId5 <
,< =
TState> D
stateE J
,J K
	ExceptionL U
	exceptionV _
,_ `
Funca e
<e f
TStatef l
,l m
	Exceptionn w
,w x
stringy 
>	 €
	formatter
 Š
)
Š ‹
{ 
if 
( 
! 
	IsEnabled 
( 
logLevel 
) 
) 
{ 
return 

;
 
} 
var 
message 
= 
	formatter 
( 
state  
,  !
	exception" +
)+ ,
;, -
if 
( 
string 
. 
IsNullOrEmpty 
( 
message #
)# $
)$ %
{ 
return 

;
 
} 
message   

=   
$"   
{   
DateTime   
.   
Now   
:   
$str   
}   
$str   !
{  ! "
logLevel  " *
}  * +
$str  + -
{  - .
message  . 5
}  5 6
$str  6 7
{  7 8
	exception  8 A
}  A B
"  B C
;  C D
try"" 
{## 
File$$ 
.$$ 	
AppendAllText$$	 
($$ 
filePath$$ 
,$$  
message$$! (
+$$) *
Environment$$+ 6
.$$6 7
NewLine$$7 >
)$$> ?
;$$? @
}%% 
catch&& 
(&&	 

	Exception&&
 
ex&& 
)&& 
{'' 
}(( 
})) 
}** 
}-- 