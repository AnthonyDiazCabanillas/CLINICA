‡Ú
ZD:\CLINICA\nsp-csfl-agenda-uti-automatizacion_qa\WsEnvioDocumentoDigitalizacion\Program.cs
	namespace 	*
WsEnvioDocumentoDigitalizacion
 (
{ 
class 	
Program
 
{   
private!! 
static!! 
IConfiguration!! %
_configuration!!& 4
;!!4 5
private"" 
static"" 
ILogger"" 
_logger"" &
;""& '
private## 
static## 
string## 
UrlToken## &
;##& '
private$$ 
static$$ 
string$$ 
UrlEnvioDoc$$ )
;$$) *
private%% 
static%% 
int%% 
TiempoDefecto%% (
;%%( )
public'' 
class'' 
ServiciosSettings'' &
{(( 	
public)) 
string)) 
UrlToken)) "
{))# $
get))% (
;))( )
set))* -
;))- .
}))/ 0
public** 
string** 
UrlEnvioDoc** %
{**& '
get**( +
;**+ ,
set**- 0
;**0 1
}**2 3
}++ 	
private-- 
static-- 
void-- 
ConfigureServices-- -
(--- .
)--. /
{.. 	
var// 
appDirectory// 
=// 
	AppDomain// (
.//( )
CurrentDomain//) 6
.//6 7
BaseDirectory//7 D
;//D E
var00 
builder00 
=00 
new00  
ConfigurationBuilder00 2
(002 3
)003 4
.11  
SetBasePath11  +
(11+ ,
appDirectory11, 8
)118 9
.22  
AddJsonFile22  +
(22+ ,
$str22, >
,22> ?
optional22@ H
:22H I
false22J O
,22O P
reloadOnChange22Q _
:22_ `
true22a e
)22e f
;22f g
_configuration33 
=33 
builder33 $
.33$ %
Build33% *
(33* +
)33+ ,
;33, -
var55 
serviceCollection55 !
=55" #
new55$ '
ServiceCollection55( 9
(559 :
)55: ;
;55; <
serviceCollection66 
.66 

AddLogging66 (
(66( )
	configure66) 2
=>663 5
{77 
	configure88 
.88 
AddConfiguration88 *
(88* +
_configuration88+ 9
.889 :

GetSection88: D
(88D E
$str88E N
)88N O
)88O P
;88P Q
	configure99 
.99 

AddConsole99 $
(99$ %
)99% &
;99& '
var:: 
logFilePath:: 
=::  !
_configuration::" 0
[::0 1
$str::1 ?
]::? @
;::@ A
if;; 
(;; 
!;; 
string;; 
.;; 
IsNullOrEmpty;; )
(;;) *
logFilePath;;* 5
);;5 6
);;6 7
{<< 
	configure== 
.== 
AddProvider== )
(==) *
new==* -
FileLoggerProvider==. @
(==@ A
logFilePath==A L
)==L M
)==M N
;==N O
}>> 
}?? 
)?? 
;?? 
varAA 
serviceProviderAA 
=AA  !
serviceCollectionAA" 3
.AA3 4 
BuildServiceProviderAA4 H
(AAH I
)AAI J
;AAJ K
_loggerBB 
=BB 
serviceProviderBB %
.BB% &

GetServiceBB& 0
<BB0 1
ILoggerBB1 8
<BB8 9
ProgramBB9 @
>BB@ A
>BBA B
(BBB C
)BBC D
;BBD E
}CC 	
staticEE 
TokenRequestEE 
ObtenerCredencialesEE /
(EE/ 0
)EE0 1
{FF 	
varGG 
pTokenRequestGG 
=GG 
newGG  #
TokenRequestGG$ 0
(GG0 1
)GG1 2
;GG2 3
varHH 
pTablasHH 
=HH 
newHH 
TablasEHH %
(HH% &
$strHH& 8
,HH8 9
$strHH: <
,HH< =
$numHH> ?
,HH? @
$numHHA B
,HHB C
-HHD E
$numHHE F
)HHF G
;HHG H
varII 
LTablasII 
=II 
newII 
TablasADII &
(II& '
)II' (
.II( )
Sp_Tablas_ConsultaII) ;
(II; <
pTablasII< C
)IIC D
;IID E
pTokenRequestKK 
.KK 
usernameKK "
=KK# $
LTablasKK% ,
[KK, -
$numKK- .
]KK. /
.KK/ 0
NombreKK0 6
.KK6 7
ToStringKK7 ?
(KK? @
)KK@ A
;KKA B
pTokenRequestLL 
.LL 
passwordLL "
=LL# $
LTablasLL% ,
[LL, -
$numLL- .
]LL. /
.LL/ 0
NombreLL0 6
.LL6 7
ToStringLL7 ?
(LL? @
)LL@ A
;LLA B
UrlTokenNN 
=NN 
LTablasNN 
[NN 
$numNN  
]NN  !
.NN! "
NombreNN" (
.NN( )
ToStringNN) 1
(NN1 2
)NN2 3
;NN3 4
UrlEnvioDocOO 
=OO 
LTablasOO !
[OO! "
$numOO" #
]OO# $
.OO$ %
NombreOO% +
.OO+ ,
ToStringOO, 4
(OO4 5
)OO5 6
;OO6 7
TiempoDefectoPP 
=PP 
ConvertPP #
.PP# $
ToInt32PP$ +
(PP+ ,
LTablasPP, 3
[PP3 4
$numPP4 5
]PP5 6
.PP6 7
NombrePP7 =
)PP= >
;PP> ?
returnQQ 
pTokenRequestQQ  
;QQ  !
}RR 	
staticTT 
ListTT 
<TT 
ResultadoEnvioTT "
>TT" #
AgruparInfoTT$ /
(TT/ 0
ListTT0 4
<TT4 5
	HospitalETT5 >
.TT> ?
ListarEnvioDocTT? M
>TTM N
LHospitalDocTTO [
)TT[ \
{UU 	
varVV 
LResultadoEnvioVV 
=VV  !
newVV" %
ListVV& *
<VV* +
ResultadoEnvioVV+ 9
>VV9 :
(VV: ;
)VV; <
;VV< =
foreachXX 
(XX 
varXX 
infoXX 
inXX  
LHospitalDocXX! -
)XX- .
{YY 
varZZ 
oDocumentosZZ 
=ZZ  !
newZZ" %
ResultadoEnvioZZ& 4
.ZZ4 5
	DocumentoZZ5 >
(ZZ> ?
)ZZ? @
;ZZ@ A
oDocumentos[[ 
.[[ 
idDocumento[[ '
=[[( )
info[[* .
.[[. /
id_documento[[/ ;
;[[; <
oDocumentos\\ 
.\\ 
idTipoDocumento\\ +
=\\, -
info\\. 2
.\\2 3
idTipoDocumento\\3 B
;\\B C
oDocumentos]] 
.]] 
nombre]] "
=]]# $
info]]% )
.]]) *
nombreDocumento]]* 9
;]]9 :
oDocumentos^^ 
.^^ 
archivo^^ #
=^^$ %
info^^& *
.^^* +
base64_documento^^+ ;
;^^; <
oDocumentos__ 
.__ 
	extencion__ %
=__& '
info__( ,
.__, -
	extension__- 6
;__6 7
oDocumentos`` 
.`` 
eliminar`` $
=``% &
info``' +
.``+ ,
eliminar``, 4
;``4 5
varbb 
oAtencionesbb 
=bb  !
newbb" %
ResultadoEnviobb& 4
.bb4 5
Atencionbb5 =
(bb= >
)bb> ?
;bb? @
oAtencionescc 
.cc 
numerocc "
=cc# $
infocc% )
.cc) *
codatencioncc* 5
;cc5 6
oAtencionesdd 
.dd 
idTipoAtenciondd *
=dd+ ,
infodd- 1
.dd1 2
idTipoAtenciondd2 @
;dd@ A
oAtencionesee 
.ee 
tipoAtencionee (
=ee) *
infoee+ /
.ee/ 0
tipoAtencionee0 <
;ee< =
oAtencionesff 
.ff 
sedeff  
=ff! "
infoff# '
.ff' (
Sedeff( ,
;ff, -
oAtencionesgg 
.gg 
nombreMedicogg (
=gg) *
infogg+ /
.gg/ 0
nombreMedicogg0 <
;gg< =
oAtencioneshh 
.hh 
especialidadMedicohh .
=hh/ 0
infohh1 5
.hh5 6
especialidadMedicohh6 H
;hhH I
oAtencionesii 
.ii 
fechaAtencionii )
=ii* +
infoii, 0
.ii0 1
fechainicioii1 <
;ii< =
oAtencionesjj 
.jj 
	documentojj %
=jj& '
oDocumentosjj( 3
;jj3 4
varll 
oResultadoEnvioll #
=ll$ %
newll& )
ResultadoEnvioll* 8
(ll8 9
)ll9 :
;ll: ;
oResultadoEnviomm 
.mm  
numeromm  &
=mm' (
infomm) -
.mm- .
numeromm. 4
;mm4 5
oResultadoEnvionn 
.nn   
numeroHistoriaClincann  4
=nn5 6
infonn7 ;
.nn; <
numeroHCnn< D
;nnD E
oResultadoEnviooo 
.oo  
nombrePacienteoo  .
=oo/ 0
infooo1 5
.oo5 6
nombrePacienteoo6 D
;ooD E
oResultadoEnviopp 
.pp   
apellidosdelPacientepp  4
=pp5 6
infopp7 ;
.pp; <
apellidosPacientepp< M
;ppM N
oResultadoEnvioqq 
.qq  
atencionqq  (
=qq) *
oAtencionesqq+ 6
;qq6 7
LResultadoEnvioss 
.ss  
Addss  #
(ss# $
oResultadoEnvioss$ 3
)ss3 4
;ss4 5
}tt 
returnvv 
LResultadoEnviovv "
;vv" #
}ww 	
staticyy 
asyncyy 
Taskyy 
<yy 
TokenResponseyy '
>yy' (
ObtenerTokenAsyncyy) :
(yy: ;
)yy; <
{zz 	
var{{ 
pTokenRequest{{ 
={{ 
ObtenerCredenciales{{  3
({{3 4
){{4 5
;{{5 6
var|| 
pTokenResponse|| 
=||  
new||! $
TokenResponse||% 2
(||2 3
)||3 4
;||4 5
string~~ 
jsonData~~ 
=~~ 
JsonConvert~~ )
.~~) *
SerializeObject~~* 9
(~~9 :
pTokenRequest~~: G
)~~G H
;~~H I
using
ÄÄ 
(
ÄÄ 
var
ÄÄ 
client
ÄÄ 
=
ÄÄ 
new
ÄÄ  #

HttpClient
ÄÄ$ .
(
ÄÄ. /
)
ÄÄ/ 0
)
ÄÄ0 1
{
ÅÅ 
var
ÇÇ 
content
ÇÇ 
=
ÇÇ 
new
ÇÇ !
StringContent
ÇÇ" /
(
ÇÇ/ 0
jsonData
ÇÇ0 8
,
ÇÇ8 9
Encoding
ÇÇ: B
.
ÇÇB C
UTF8
ÇÇC G
,
ÇÇG H
$str
ÇÇI [
)
ÇÇ[ \
;
ÇÇ\ ]
var
ÉÉ 
response
ÉÉ 
=
ÉÉ 
await
ÉÉ $
client
ÉÉ% +
.
ÉÉ+ ,
	PostAsync
ÉÉ, 5
(
ÉÉ5 6
UrlToken
ÉÉ6 >
,
ÉÉ> ?
content
ÉÉ@ G
)
ÉÉG H
;
ÉÉH I
var
ÑÑ 
responseString
ÑÑ "
=
ÑÑ# $
await
ÑÑ% *
response
ÑÑ+ 3
.
ÑÑ3 4
Content
ÑÑ4 ;
.
ÑÑ; <
ReadAsStringAsync
ÑÑ< M
(
ÑÑM N
)
ÑÑN O
;
ÑÑO P
if
ÜÜ 
(
ÜÜ 
response
ÜÜ 
.
ÜÜ 

StatusCode
ÜÜ '
==
ÜÜ( *
HttpStatusCode
ÜÜ+ 9
.
ÜÜ9 :
OK
ÜÜ: <
)
ÜÜ< =
{
áá 
pTokenResponse
àà "
=
àà# $
JsonConvert
àà% 0
.
àà0 1
DeserializeObject
àà1 B
<
ààB C
TokenResponse
ààC P
>
ààP Q
(
ààQ R
responseString
ààR `
)
àà` a
;
ààa b
}
ââ 
}
ää 
return
ãã 
pTokenResponse
ãã !
;
ãã! "
}
åå 	
static
éé 
async
éé 
Task
éé 
<
éé !
ResponseApiScanFlow
éé -
>
éé- ."
EnviarDocumentoAsync
éé/ C
(
ééC D
string
ééD J
jsonData
ééK S
,
ééS T
string
ééU [
token
éé\ a
,
ééa b
int
ééc f
numDocumento
éég s
)
éés t
{
èè 	
var
êê "
oResponseApiScanFlow
êê $
=
êê% &
new
êê' *!
ResponseApiScanFlow
êê+ >
(
êê> ?
)
êê? @
;
êê@ A
using
íí 
(
íí 
var
íí 
client
íí 
=
íí 
new
íí  #

HttpClient
íí$ .
(
íí. /
)
íí/ 0
)
íí0 1
{
ìì 
client
îî 
.
îî #
DefaultRequestHeaders
îî ,
.
îî, -
Authorization
îî- :
=
îî; <
new
îî= @
System
îîA G
.
îîG H
Net
îîH K
.
îîK L
Http
îîL P
.
îîP Q
Headers
îîQ X
.
îîX Y'
AuthenticationHeaderValue
îîY r
(
îîr s
$str
îîs {
,
îî{ |
tokenîî} Ç
)îîÇ É
;îîÉ Ñ
client
ïï 
.
ïï 
Timeout
ïï 
=
ïï  
TimeSpan
ïï! )
.
ïï) *
FromSeconds
ïï* 5
(
ïï5 6
TiempoDefecto
ïï6 C
)
ïïC D
;
ïïD E
var
óó 
content
óó 
=
óó 
new
óó !
StringContent
óó" /
(
óó/ 0
jsonData
óó0 8
,
óó8 9
Encoding
óó: B
.
óóB C
UTF8
óóC G
,
óóG H
$str
óóI [
)
óó[ \
;
óó\ ]
var
òò 
response
òò 
=
òò 
await
òò $
client
òò% +
.
òò+ ,
	PostAsync
òò, 5
(
òò5 6
UrlEnvioDoc
òò6 A
,
òòA B
content
òòC J
)
òòJ K
;
òòK L
var
ôô 
responseString
ôô "
=
ôô# $
await
ôô% *
response
ôô+ 3
.
ôô3 4
Content
ôô4 ;
.
ôô; <
ReadAsStringAsync
ôô< M
(
ôôM N
)
ôôN O
;
ôôO P"
oResponseApiScanFlow
õõ $
.
õõ$ %
CodRespuesta
õõ% 1
=
õõ2 3
Convert
õõ4 ;
.
õõ; <
ToInt32
õõ< C
(
õõC D
response
õõD L
.
õõL M

StatusCode
õõM W
)
õõW X
;
õõX Y
if
úú 
(
úú 
response
úú 
.
úú 

StatusCode
úú '
==
úú( *
HttpStatusCode
úú+ 9
.
úú9 :
OK
úú: <
)
úú< =
{
ùù "
oResponseApiScanFlow
ûû (
.
ûû( )
	esEnviado
ûû) 2
=
ûû3 4
true
ûû5 9
;
ûû9 :
return
üü "
oResponseApiScanFlow
üü /
;
üü/ 0
}
†† 
else
°° 
{
¢¢ "
oResponseApiScanFlow
££ (
.
££( )
	esEnviado
££) 2
=
££3 4
false
££5 :
;
££: ;
return
§§ "
oResponseApiScanFlow
§§ /
;
§§/ 0
}
•• 
}
¶¶ 
}
ßß 	
static
©© 
bool
©© !
ActualizarDocumento
©© '
(
©©' (
int
©©( +
id_documento
©©, 8
,
©©8 9
bool
©©: >
	EsExitoso
©©? H
)
©©H I
{
™™ 	
string
´´ 
Exito
´´ 
=
´´ 
(
´´ 
	EsExitoso
´´ %
==
´´& (
true
´´) -
)
´´- .
?
´´/ 0
$str
´´1 4
:
´´5 6
$str
´´7 :
;
´´: ;
var
¨¨ 
pDoc
¨¨ 
=
¨¨ 
new
¨¨ 
HospitalDocE
¨¨ '
(
¨¨' (
id_documento
¨¨( 4
,
¨¨4 5
$str
¨¨6 8
,
¨¨8 9
null
¨¨: >
,
¨¨> ?
$str
¨¨@ R
)
¨¨R S
;
¨¨S T
bool
≠≠ 
Esctualizado
≠≠ 
=
≠≠ 
new
≠≠  #
HospitalDocAD
≠≠$ 1
(
≠≠1 2
)
≠≠2 3
.
≠≠3 4)
Sp_HospitalDoc_UpdatexCampo
≠≠4 O
(
≠≠O P
pDoc
≠≠P T
)
≠≠T U
;
≠≠U V
var
ØØ 
pDocExitoso
ØØ 
=
ØØ 
new
ØØ !
HospitalDocE
ØØ" .
(
ØØ. /
id_documento
ØØ/ ;
,
ØØ; <
Exito
ØØ= B
,
ØØB C
null
ØØD H
,
ØØH I
$str
ØØJ \
)
ØØ\ ]
;
ØØ] ^
Esctualizado
∞∞ 
=
∞∞ 
new
∞∞ 
HospitalDocAD
∞∞ ,
(
∞∞, -
)
∞∞- .
.
∞∞. /)
Sp_HospitalDoc_UpdatexCampo
∞∞/ J
(
∞∞J K
pDocExitoso
∞∞K V
)
∞∞V W
;
∞∞W X
return
±± 
Esctualizado
±± 
;
±±  
}
≤≤ 	
static
¥¥ 
void
¥¥ 
EnviarCorreo
¥¥  
(
¥¥  !
string
¥¥! '
cuerpo
¥¥( .
)
¥¥. /
{
µµ 	
string
∂∂ 
asunto
∂∂ 
=
∂∂ 
$str
∂∂ D
;
∂∂D E
var
∑∑ 
oCorreoE
∑∑ 
=
∑∑ 
new
∑∑ 
CorreoE
∑∑ &
(
∑∑& '
asunto
∑∑' -
,
∑∑- .
cuerpo
∑∑/ 5
)
∑∑5 6
;
∑∑6 7
new
∏∏ 
SisCorreoAD
∏∏ 
(
∏∏ 
)
∏∏ 
.
∏∏ %
Sp_CorreoDigitalizacion
∏∏ 5
(
∏∏5 6
oCorreoE
∏∏6 >
)
∏∏> ?
;
∏∏? @
}
ππ 	
static
ªª 
async
ªª 
Task
ªª 
Main
ªª 
(
ªª 
string
ªª %
[
ªª% &
]
ªª& '
args
ªª( ,
)
ªª, -
{
ºº 	
try
ΩΩ 
{
ææ 
ConfigureServices
øø !
(
øø! "
)
øø" #
;
øø# $
_logger
¡¡ 
.
¡¡ 
LogInformation
¡¡ &
(
¡¡& '
$str
¡¡' ;
)
¡¡; <
;
¡¡< =
VariablesGlobales
¬¬ !
.
¬¬! "

CnnClinica
¬¬" ,
=
¬¬- .
_configuration
¬¬/ =
.
¬¬= >!
GetConnectionString
¬¬> Q
(
¬¬Q R
$str
¬¬R e
)
¬¬e f
;
¬¬f g
int
ƒƒ 
contadorTotal
ƒƒ !
=
ƒƒ" #
$num
ƒƒ$ %
;
ƒƒ% &
bool
≈≈ 
hayMasRegistros
≈≈ $
=
≈≈% &
true
≈≈' +
;
≈≈+ ,

Dictionary
∆∆ 
<
∆∆ 
int
∆∆ 
,
∆∆ 
int
∆∆  #
>
∆∆# $
intentosFallidos
∆∆% 5
=
∆∆6 7
new
∆∆8 ;

Dictionary
∆∆< F
<
∆∆F G
int
∆∆G J
,
∆∆J K
int
∆∆L O
>
∆∆O P
(
∆∆P Q
)
∆∆Q R
;
∆∆R S
while
…… 
(
…… 
hayMasRegistros
…… &
)
……& '
{
   
int
ÀÀ 
orden
ÀÀ 
=
ÀÀ 
$num
ÀÀ  !
;
ÀÀ! "
var
ÃÃ 
LHospitalDoc
ÃÃ $
=
ÃÃ% &
await
ÃÃ' ,
new
ÃÃ- 0
HospitalDocAD
ÃÃ1 >
(
ÃÃ> ?
)
ÃÃ? @
.
ÃÃ@ A!
ListarEnvioDocAsync
ÃÃA T
(
ÃÃT U
orden
ÃÃU Z
)
ÃÃZ [
;
ÃÃ[ \
if
ÕÕ 
(
ÕÕ 
LHospitalDoc
ÕÕ $
.
ÕÕ$ %
Count
ÕÕ% *
==
ÕÕ+ -
$num
ÕÕ. /
)
ÕÕ/ 0
{
ŒŒ 
hayMasRegistros
œœ '
=
œœ( )
false
œœ* /
;
œœ/ 0
break
–– 
;
–– 
}
—— 
var
‘‘ 
LInfoAgrupada
‘‘ %
=
‘‘& '
AgruparInfo
‘‘( 3
(
‘‘3 4
LHospitalDoc
‘‘4 @
)
‘‘@ A
;
‘‘A B
var
’’ 
oTokenResponse
’’ &
=
’’' (
await
’’) .
ObtenerTokenAsync
’’/ @
(
’’@ A
)
’’A B
;
’’B C
if
◊◊ 
(
◊◊ 
oTokenResponse
◊◊ &
.
◊◊& '
token
◊◊' ,
==
◊◊- /
null
◊◊0 4
)
◊◊4 5
{
ÿÿ 
hayMasRegistros
ŸŸ '
=
ŸŸ( )
false
ŸŸ* /
;
ŸŸ/ 0
string
⁄⁄ 
MensajeError
⁄⁄ +
=
⁄⁄, -
$str⁄⁄. ü
;⁄⁄ü †
EnviarCorreo
€€ $
(
€€$ %
MensajeError
€€% 1
)
€€1 2
;
€€2 3
_logger
‹‹ 
.
‹‹  

LogWarning
‹‹  *
(
‹‹* +
MensajeError
‹‹+ 7
)
‹‹7 8
;
‹‹8 9
break
›› 
;
›› 
}
ﬁﬁ 
int
·· 
contador
··  
=
··! "
$num
··# $
;
··$ %
foreach
‚‚ 
(
‚‚ 
var
‚‚  
info
‚‚! %
in
‚‚& (
LInfoAgrupada
‚‚) 6
)
‚‚6 7
{
„„ 
var
‰‰ 
numDocumento
‰‰ (
=
‰‰) *
info
‰‰+ /
.
‰‰/ 0
atencion
‰‰0 8
.
‰‰8 9
	documento
‰‰9 B
.
‰‰B C
idDocumento
‰‰C N
;
‰‰N O
var
ÂÂ 
	jsonEnvio
ÂÂ %
=
ÂÂ& '
JsonConvert
ÂÂ( 3
.
ÂÂ3 4
SerializeObject
ÂÂ4 C
(
ÂÂC D
info
ÂÂD H
)
ÂÂH I
;
ÂÂI J
if
ËË 
(
ËË 
intentosFallidos
ËË ,
.
ËË, -
ContainsKey
ËË- 8
(
ËË8 9
numDocumento
ËË9 E
)
ËËE F
&&
ËËG I
intentosFallidos
ËËJ Z
[
ËËZ [
numDocumento
ËË[ g
]
ËËg h
>=
ËËi k
$num
ËËl m
)
ËËm n
{
ÈÈ 
string
ÍÍ "
MensajeError
ÍÍ# /
=
ÍÍ0 1
$str
ÍÍ2 H
+
ÍÍI J
numDocumento
ÍÍK W
.
ÍÍW X
ToString
ÍÍX `
(
ÍÍ` a
)
ÍÍa b
+
ÍÍc d
$strÍÍe ë
;ÍÍë í
EnviarCorreo
ÎÎ (
(
ÎÎ( )
MensajeError
ÎÎ) 5
)
ÎÎ5 6
;
ÎÎ6 7
_logger
ÏÏ #
.
ÏÏ# $

LogWarning
ÏÏ$ .
(
ÏÏ. /
MensajeError
ÏÏ/ ;
)
ÏÏ; <
;
ÏÏ< =
continue
ÌÌ $
;
ÌÌ$ %
}
ÓÓ 
var
ÒÒ 
	oResponse
ÒÒ %
=
ÒÒ& '
await
ÒÒ( -"
EnviarDocumentoAsync
ÒÒ. B
(
ÒÒB C
	jsonEnvio
ÒÒC L
,
ÒÒL M
oTokenResponse
ÒÒN \
.
ÒÒ\ ]
token
ÒÒ] b
,
ÒÒb c
numDocumento
ÒÒd p
)
ÒÒp q
;
ÒÒq r
if
ÛÛ 
(
ÛÛ 
	oResponse
ÛÛ %
.
ÛÛ% &
	esEnviado
ÛÛ& /
)
ÛÛ/ 0
{
ÙÙ 
contador
ıı $
++
ıı$ &
;
ıı& '!
ActualizarDocumento
ˆˆ /
(
ˆˆ/ 0
info
ˆˆ0 4
.
ˆˆ4 5
atencion
ˆˆ5 =
.
ˆˆ= >
	documento
ˆˆ> G
.
ˆˆG H
idDocumento
ˆˆH S
,
ˆˆS T
	oResponse
ˆˆU ^
.
ˆˆ^ _
	esEnviado
ˆˆ_ h
)
ˆˆh i
;
ˆˆi j
if
˜˜ 
(
˜˜  
intentosFallidos
˜˜  0
.
˜˜0 1
ContainsKey
˜˜1 <
(
˜˜< =
numDocumento
˜˜= I
)
˜˜I J
)
˜˜J K
{
¯¯ 
intentosFallidos
˘˘  0
.
˘˘0 1
Remove
˘˘1 7
(
˘˘7 8
numDocumento
˘˘8 D
)
˘˘D E
;
˘˘E F
}
˙˙ 
}
˚˚ 
else
¸¸ 
{
˝˝ 
if
˛˛ 
(
˛˛  
	oResponse
˛˛  )
.
˛˛) *
CodRespuesta
˛˛* 6
==
˛˛7 9
$num
˛˛: =
)
˛˛= >
{
ˇˇ 
hayMasRegistros
ÄÄ  /
=
ÄÄ0 1
false
ÄÄ2 7
;
ÄÄ7 8
string
ÅÅ  &
MensajeError
ÅÅ' 3
=
ÅÅ4 5
$str
ÅÅ6 ?
+
ÅÅ? @
	oResponse
ÅÅ@ I
.
ÅÅI J
CodRespuesta
ÅÅJ V
.
ÅÅV W
ToString
ÅÅW _
(
ÅÅ_ `
)
ÅÅ` a
+
ÅÅa b
$strÅÅb õ
;ÅÅõ ú
EnviarCorreo
ÇÇ  ,
(
ÇÇ, -
MensajeError
ÇÇ- 9
)
ÇÇ9 :
;
ÇÇ: ;
_logger
ÉÉ  '
.
ÉÉ' (

LogWarning
ÉÉ( 2
(
ÉÉ2 3
MensajeError
ÉÉ3 ?
)
ÉÉ? @
;
ÉÉ@ A
break
ÑÑ  %
;
ÑÑ% &
}
ÖÖ 
if
àà 
(
àà  
intentosFallidos
àà  0
.
àà0 1
ContainsKey
àà1 <
(
àà< =
numDocumento
àà= I
)
ààI J
)
ààJ K
{
ââ 
intentosFallidos
ää  0
[
ää0 1
numDocumento
ää1 =
]
ää= >
++
ää> @
;
ää@ A
}
ãã 
else
åå  
{
çç 
intentosFallidos
éé  0
[
éé0 1
numDocumento
éé1 =
]
éé= >
=
éé? @
$num
ééA B
;
ééB C
}
èè 
if
íí 
(
íí  
intentosFallidos
íí  0
[
íí0 1
numDocumento
íí1 =
]
íí= >
==
íí? A
$num
ííB C
)
ííC D
{
ìì !
ActualizarDocumento
îî  3
(
îî3 4
info
îî4 8
.
îî8 9
atencion
îî9 A
.
îîA B
	documento
îîB K
.
îîK L
idDocumento
îîL W
,
îîW X
	oResponse
îîY b
.
îîb c
	esEnviado
îîc l
)
îîl m
;
îîm n
_logger
ïï  '
.
ïï' (

LogWarning
ïï( 2
(
ïï2 3
$"
ïï3 5
$str
ïï5 I
{
ïïI J
numDocumento
ïïJ V
}
ïïV W
$str
ïïW f
"
ïïf g
)
ïïg h
;
ïïh i
}
ññ 
}
óó 
}
òò 
contadorTotal
öö !
+=
öö" $
contador
öö% -
;
öö- .
_logger
õõ 
.
õõ 
LogInformation
õõ *
(
õõ* +
$"
õõ+ -
$str
õõ- 8
{
õõ8 9
contador
õõ9 A
}
õõA B
$str
õõB z
{
õõz {
contadorTotalõõ{ à
}õõà â
"õõâ ä
)õõä ã
;õõã å
}
úú 
int
üü 
contadorNew
üü 
=
üü  !
$num
üü" #
;
üü# $
int
†† 
ordenRechazado
†† "
=
††# $
$num
††% &
;
††& '
var
°° #
LHospitalDocRechazado
°° )
=
°°* +
await
°°, 1
new
°°2 5
HospitalDocAD
°°6 C
(
°°C D
)
°°D E
.
°°E F!
ListarEnvioDocAsync
°°F Y
(
°°Y Z
ordenRechazado
°°Z h
)
°°h i
;
°°i j
if
¢¢ 
(
¢¢ #
LHospitalDocRechazado
¢¢ )
.
¢¢) *
Count
¢¢* /
>
¢¢0 1
$num
¢¢2 3
)
¢¢3 4
{
££ 
var
•• 
LInfoAgrupada
•• %
=
••& '
AgruparInfo
••( 3
(
••3 4#
LHospitalDocRechazado
••4 I
)
••I J
;
••J K
var
¶¶ 
oTokenResponse
¶¶ &
=
¶¶' (
await
¶¶) .
ObtenerTokenAsync
¶¶/ @
(
¶¶@ A
)
¶¶A B
;
¶¶B C
if
®® 
(
®® 
oTokenResponse
®® &
.
®®& '
token
®®' ,
!=
®®- /
null
®®0 4
)
®®4 5
{
©© 
foreach
™™ 
(
™™  !
var
™™! $
info
™™% )
in
™™* ,
LInfoAgrupada
™™- :
)
™™: ;
{
´´ 
var
¨¨ 
numDocumento
¨¨  ,
=
¨¨- .
info
¨¨/ 3
.
¨¨3 4
atencion
¨¨4 <
.
¨¨< =
	documento
¨¨= F
.
¨¨F G
idDocumento
¨¨G R
;
¨¨R S
var
≠≠ 
	jsonEnvio
≠≠  )
=
≠≠* +
JsonConvert
≠≠, 7
.
≠≠7 8
SerializeObject
≠≠8 G
(
≠≠G H
info
≠≠H L
)
≠≠L M
;
≠≠M N
var
ÆÆ 
	oResponse
ÆÆ  )
=
ÆÆ* +
await
ÆÆ, 1"
EnviarDocumentoAsync
ÆÆ2 F
(
ÆÆF G
	jsonEnvio
ÆÆG P
,
ÆÆP Q
oTokenResponse
ÆÆR `
.
ÆÆ` a
token
ÆÆa f
,
ÆÆf g
numDocumento
ÆÆh t
)
ÆÆt u
;
ÆÆu v
if
∞∞ 
(
∞∞  
	oResponse
∞∞  )
.
∞∞) *
	esEnviado
∞∞* 3
)
∞∞3 4
{
±± 
contadorNew
≤≤  +
++
≤≤+ -
;
≤≤- .!
ActualizarDocumento
≥≥  3
(
≥≥3 4
info
≥≥4 8
.
≥≥8 9
atencion
≥≥9 A
.
≥≥A B
	documento
≥≥B K
.
≥≥K L
idDocumento
≥≥L W
,
≥≥W X
	oResponse
≥≥Y b
.
≥≥b c
	esEnviado
≥≥c l
)
≥≥l m
;
≥≥m n
}
¥¥ 
}
µµ 
}
∂∂ 
}
∑∑ 
contadorTotal
ππ 
+=
ππ  
contadorNew
ππ! ,
;
ππ, -
_logger
∫∫ 
.
∫∫ 
LogInformation
∫∫ &
(
∫∫& '
$"
∫∫' )
$str
∫∫) O
{
∫∫O P
contadorNew
∫∫P [
}
∫∫[ \
$str∫∫\ î
{∫∫î ï
contadorTotal∫∫ï ¢
}∫∫¢ £
"∫∫£ §
)∫∫§ •
;∫∫• ¶
_logger
ªª 
.
ªª 
LogInformation
ªª &
(
ªª& '
$"
ªª' )
$str
ªª) F
{
ªªF G
contadorTotal
ªªG T
}
ªªT U
$str
ªªU j
"
ªªj k
)
ªªk l
;
ªªl m
}
ºº 
catch
ΩΩ 
(
ΩΩ 
	Exception
ΩΩ 
ex
ΩΩ 
)
ΩΩ  
{
ææ 
_logger
øø 
.
øø 
LogError
øø  
(
øø  !
ex
øø! #
,
øø# $
$str
øø% Z
)
øøZ [
;
øø[ \
}
¿¿ 
}
¡¡ 	
public
√√ 
class
√√ !
ResponseApiScanFlow
√√ (
{
ƒƒ 	
public
≈≈ 
bool
≈≈ 
	esEnviado
≈≈ !
{
≈≈" #
get
≈≈$ '
;
≈≈' (
set
≈≈) ,
;
≈≈, -
}
≈≈. /
public
∆∆ 
int
∆∆ 
CodRespuesta
∆∆ #
{
∆∆$ %
get
∆∆& )
;
∆∆) *
set
∆∆+ .
;
∆∆. /
}
∆∆0 1
}
«« 	
}
…… 
}   Ã
eD:\CLINICA\nsp-csfl-agenda-uti-automatizacion_qa\WsEnvioDocumentoDigitalizacion\FileLoggerProvider.cs
	namespace 	*
WsEnvioDocumentoDigitalizacion
 (
{		 
public

 

class

 
FileLoggerProvider

 #
:

$ %
ILoggerProvider

& 5
{ 
private 	
readonly
 
string 
path 
; 
public 
FileLoggerProvider	 
( 
string "
path# '
)' (
{ 
this 
. 
path 
= 
path 
; 
} 
public 
ILogger	 
CreateLogger 
( 
string $
categoryName% 1
)1 2
{ 
return 	
new
 

FileLogger 
( 
path 
) 
; 
} 
public 
void	 
Dispose 
( 
) 
{ 
} 
} 
} ’
]D:\CLINICA\nsp-csfl-agenda-uti-automatizacion_qa\WsEnvioDocumentoDigitalizacion\FileLogger.cs
	namespace

 	*
WsEnvioDocumentoDigitalizacion


 (
{ 
public 
class 

FileLogger 
: 
ILogger "
{ 
private 	
readonly
 
string 
filePath "
;" #
public 

FileLogger	 
( 
string 
path 
)  
{ 
filePath 
= 
path 
; 
} 
public 
IDisposable	 

BeginScope 
<  
TState  &
>& '
(' (
TState( .
state/ 4
)4 5
=>6 8
null9 =
;= >
public 
bool	 
	IsEnabled 
( 
LogLevel  
logLevel! )
)) *
=>+ -
true. 2
;2 3
public 
void	 
Log 
< 
TState 
> 
( 
LogLevel "
logLevel# +
,+ ,
EventId- 4
eventId5 <
,< =
TState> D
stateE J
,J K
	ExceptionL U
	exceptionV _
,_ `
Funca e
<e f
TStatef l
,l m
	Exceptionn w
,w x
stringy 
>	 Ä
	formatter
Å ä
)
ä ã
{ 
if 
( 
! 
	IsEnabled 
( 
logLevel 
) 
) 
{ 
return 

;
 
} 
var   
message   
=   
	formatter   
(   
state    
,    !
	exception  " +
)  + ,
;  , -
if!! 
(!! 
string!! 
.!! 
IsNullOrEmpty!! 
(!! 
message!! #
)!!# $
)!!$ %
{"" 
return## 

;##
 
}$$ 
message&& 

=&& 
$"&& 
{&& 
DateTime&& 
.&& 
Now&& 
:&& 
$str&& 
}&& 
$str&& !
{&&! "
logLevel&&" *
}&&* +
$str&&+ -
{&&- .
message&&. 5
}&&5 6
$str&&6 7
{&&7 8
	exception&&8 A
}&&A B
"&&B C
;&&C D
try(( 
{)) 
File** 
.** 	
AppendAllText**	 
(** 
filePath** 
,**  
message**! (
+**) *
Environment**+ 6
.**6 7
NewLine**7 >
)**> ?
;**? @
}++ 
catch,, 
(,,	 

	Exception,,
 
ex,, 
),, 
{-- 
}.. 
}// 
}00 
}11 ‡
gD:\CLINICA\nsp-csfl-agenda-uti-automatizacion_qa\WsEnvioDocumentoDigitalizacion\Clases\TokenResponse.cs
	namespace 	*
WsEnvioDocumentoDigitalizacion
 (
{ 
public 

class 
TokenResponse 
{ 
public 
string 
token 
{ 
get !
;! "
set# &
;& '
}( )
public 
string 
timpoExpiracion %
{& '
get( +
;+ ,
set- 0
;0 1
}2 3
} 
} ⁄
fD:\CLINICA\nsp-csfl-agenda-uti-automatizacion_qa\WsEnvioDocumentoDigitalizacion\Clases\TokenRequest.cs
	namespace 	*
WsEnvioDocumentoDigitalizacion
 (
{ 
public 

class 
TokenRequest 
{ 
public 
string 
username 
{  
get! $
;$ %
set& )
;) *
}+ ,
public 
string 
password 
{  
get! $
;$ %
set& )
;) *
}+ ,
} 
} ⁄
hD:\CLINICA\nsp-csfl-agenda-uti-automatizacion_qa\WsEnvioDocumentoDigitalizacion\Clases\ResultadoEnvio.cs
	namespace 	*
WsEnvioDocumentoDigitalizacion
 (
{ 
public 

class 
ResultadoEnvio 
{ 
public 
string 
numero 
{ 
get "
;" #
set$ '
;' (
}) *
public 
string  
numeroHistoriaClinca *
{+ ,
get- 0
;0 1
set2 5
;5 6
}7 8
public 
string 
nombrePaciente $
{% &
get' *
;* +
set, /
;/ 0
}1 2
public 
string  
apellidosdelPaciente *
{+ ,
get- 0
;0 1
set2 5
;5 6
}7 8
public 
Atencion 
atencion  
{! "
get# &
;& '
set( +
;+ ,
}- .
public 
class 
	Documento 
{ 	
public 
int 
idDocumento "
{# $
get% (
;( )
set* -
;- .
}/ 0
public 
int 
idTipoDocumento &
{' (
get) ,
;, -
set. 1
;1 2
}3 4
public 
string 
nombre  
{! "
get# &
;& '
set( +
;+ ,
}- .
public 
string 
archivo !
{" #
get$ '
;' (
set) ,
;, -
}. /
public 
string 
	extencion #
{$ %
get& )
;) *
set+ .
;. /
}0 1
public   
bool   
eliminar    
{  ! "
get  # &
;  & '
set  ( +
;  + ,
}  - .
=  / 0
false  1 6
;  6 7
}!! 	
public## 
class## 
Atencion## 
{$$ 	
public%% 
string%% 
numero%%  
{%%! "
get%%# &
;%%& '
set%%( +
;%%+ ,
}%%- .
public&& 
int&& 
idTipoAtencion&& %
{&&& '
get&&( +
;&&+ ,
set&&- 0
;&&0 1
}&&2 3
public'' 
string'' 
tipoAtencion'' &
{''' (
get'') ,
;'', -
set''. 1
;''1 2
}''3 4
public(( 
string(( 
sede(( 
{((  
get((! $
;(($ %
set((& )
;(() *
}((+ ,
public)) 
string)) 
nombreMedico)) &
{))' (
get))) ,
;)), -
set)). 1
;))1 2
}))3 4
public** 
string** 
especialidadMedico** ,
{**- .
get**/ 2
;**2 3
set**4 7
;**7 8
}**9 :
public++ 
DateTime++ 
fechaAtencion++ )
{++* +
get++, /
;++/ 0
set++1 4
;++4 5
}++6 7
public-- 
	Documento-- 
	documento-- &
{--' (
get--) ,
;--, -
set--. 1
;--1 2
}--3 4
}.. 	
}// 
}00 