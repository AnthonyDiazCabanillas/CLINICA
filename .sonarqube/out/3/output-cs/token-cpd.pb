≥
SD:\CLINICA\nsp-csfl-agenda-uti-automatizacion_qa\GeneracionReporteDietas\Program.cs
	namespace 	#
GeneracionReporteDietas
 !
{ 
class 
Program 
{ 
private 	
static
 
IConfiguration 
_configuration  .
;. /
private 	
static
 
ILogger 
_logger  
;  !
static 
void	 
Main 
( 
string 
[ 
] 
args  
)  !
{ 
ConfigureServices 
( 
) 
; 
try 
{ 
_logger 
. 
LogInformation 
( 
$str /
)/ 0
;0 1
string 

connectionString 
= 
_configuration ,
., -
GetConnectionString- @
(@ A
$strA T
)T U
;U V
string 

sharedFolderPath 
= 
_configuration ,
[, -
$str- ?
]? @
;@ A
var!! 
	tableHtml!! 
=!! !
FetchDataFromDatabase!! )
(!!) *
connectionString!!* :
)!!: ;
;!!; <
string"" 

shift"" 
="" 
DetermineShift"" !
(""! "
)""" #
;""# $
var## 
pdfPath## 
=## 
GeneratePdf## 
(## 
	tableHtml## '
,##' (
sharedFolderPath##) 9
,##9 :
shift##; @
)##@ A
;##A B
SendEmailWithPdf$$ 
($$ 
connectionString$$ %
,$$% &
pdfPath$$' .
)$$. /
;$$/ 0
File%% 
.%% 	
Delete%%	 
(%% 
pdfPath%% 
)%% 
;%% 
_logger&& 
.&& 
LogInformation&& 
(&& 
$str&& ,
)&&, -
;&&- .
}'' 
catch(( 
(((	 

	Exception((
 
ex(( 
)(( 
{)) 
_logger** 
.** 
LogError** 
(** 
ex** 
,** 
$str** N
)**N O
;**O P
}++ 
},, 
private.. 	
static..
 
string.. !
FetchDataFromDatabase.. -
(..- .
string... 4
connectionString..5 E
)..E F
{// 
string00 	
storedProcedure00
 
=00 
$str00 3
;003 4
var11 
	tableHtml11 
=11 
$str11 
;11 
using33 
(33	 

var33
 

connection33 
=33 
new33 
SqlConnection33 ,
(33, -
connectionString33- =
)33= >
)33> ?
{44 
try55 
{66 

connection77 
.77 
Open77 
(77 
)77 
;77 
using88 

(88 
var88 
command88 
=88 
new88 

SqlCommand88 (
(88( )
storedProcedure88) 8
,888 9

connection88: D
)88D E
)88E F
{99 
command:: 
.:: 
CommandType:: 
=:: 
CommandType:: '
.::' (
StoredProcedure::( 7
;::7 8
using;; 
(;; 
var;; 
reader;; 
=;; 
command;; !
.;;! "
ExecuteReader;;" /
(;;/ 0
);;0 1
);;1 2
{<< 
while== 
(== 
reader== 
.== 
Read== 
(== 
)== 
)== 
{>> 
	tableHtml?? 
+=?? 
$str?? 
;?? 
for@@ 
(@@ 
int@@ 
i@@ 
=@@ 
$num@@ 
;@@ 
i@@ 
<@@ 
reader@@ "
.@@" #

FieldCount@@# -
;@@- .
i@@/ 0
++@@0 2
)@@2 3
{AA 	
ifBB	 
(BB 
iBB 
==BB 
$numBB 
)BB 
continueBB 
;BB 
	tableHtmlCC	 
+=CC 
$strCC 
+CC 
readerCC %
[CC% &
iCC& '
]CC' (
.CC( )
ToStringCC) 1
(CC1 2
)CC2 3
+CC4 5
$strCC6 =
;CC= >
}DD 	
	tableHtmlEE 
+=EE 
$strEE 
;EE 
}FF 
}GG 
}HH 
}II 
catchJJ 	
(JJ
 
SqlExceptionJJ 
exJJ 
)JJ 
{KK 
_loggerLL 
.LL 
LogErrorLL 
(LL 
exLL 
,LL 
$strLL G
)LLG H
;LLH I
throwMM 

;MM
 
}NN 
}OO 
returnQQ 	
	tableHtmlQQ
 
;QQ 
}RR 
privateTT 	
staticTT
 
stringTT 
GeneratePdfTT #
(TT# $
stringTT$ *
	tableHtmlTT+ 4
,TT4 5
stringTT6 <
sharedFolderPathTT= M
,TTM N
stringTTO U
shiftTTV [
)TT[ \
{UU 
varVV 
guidVV 
=VV 
GuidVV 
.VV 
NewGuidVV 
(VV 
)VV 
;VV 
stringWW 	
pdfPathWW
 
=WW 
PathWW 
.WW 
CombineWW  
(WW  !
sharedFolderPathWW! 1
,WW1 2
$strWW3 B
+WWC D
guidWWE I
+WWJ K
$strWWL R
)WWR S
;WWS T
tryYY 
{ZZ 
string[[ 


htmlString[[ 
=[[ 
$str[[  
+[[! "
$str\\ 
+\\ 
$str]] 
+]] 
$str^^ 
+^^ 
$str__ !
+__" #
$str`` "
+``# $
$straa !
+aa" #
$strbb 
+bb 
$strcc 
+cc 
$strdd  
+dd! "
$stree .
+ee/ 0
$strff (
+ff) *
$strgg 
+gg 
$strhh 
+hh 
$strii .
+ii/ 0
$strjj !
+jj" #
$strkk 
+kk 
$strll 
+ll 
$strmm ,
+mm- .
$strnn !
+nn" #
$stroo %
+oo& '
$strpp *
+pp+ ,
$strqq 
+qq 
$strrr 
+rr 
$strss "
+ss# $
$strtt 
+tt  !
$struu 
+uu 
$strvv 
+vv 
$strww 
+ww  !
$strxx 
+xx 
$stryy 
+yy  
$strzz '
+zz( )
$str{{ $
+{{% &
$str|| %
+||& '
$str}} (
+}}) *
$str~~ 
+~~ 
$str 
+ 
$str
ÄÄ 
+
ÄÄ 
$str
ÅÅ 
+
ÅÅ 
$str
ÇÇ G
+
ÇÇH I
DateTime
ÇÇJ R
.
ÇÇR S
Now
ÇÇS V
.
ÇÇV W
ToString
ÇÇW _
(
ÇÇ_ `
$str
ÇÇ` c
)
ÇÇc d
+
ÇÇe f
$str
ÇÇg j
+
ÇÇk l
shift
ÇÇm r
+
ÇÇs t
$str
ÇÇu }
+
ÇÇ~ 
$str
ÉÉ 
+
ÉÉ 
$str
ÑÑ !
+
ÑÑ" #
$str
ÖÖ 9
+
ÖÖ: ;
$str
ÜÜ 8
+
ÜÜ9 :
$str
áá I
+
ááJ K
$str
àà 9
+
àà: ;
$str
ââ :
+
ââ; <
$str
ää :
+
ää; <
$str
ãã !
+
ãã" #
$str
åå +
+
åå, -
$str
çç 3
+
çç4 5
$str
éé J
+
ééK L
$str
èè $
+
èè% &
	tableHtml
èè' 0
+
èè1 2
$str
êê 
+
êê 
$str
ëë 
+
ëë 
$str
íí 
;
íí 
using
îî 	
(
îî
 
	PdfWriter
îî 
writer
îî 
=
îî 
new
îî !
	PdfWriter
îî" +
(
îî+ ,
pdfPath
îî, 3
)
îî3 4
)
îî4 5
{
ïï 
using
ññ 

(
ññ 
PdfDocument
ññ 
pdf
ññ 
=
ññ 
new
ññ !
PdfDocument
ññ" -
(
ññ- .
writer
ññ. 4
)
ññ4 5
)
ññ5 6
{
óó 
pdf
òò 	
.
òò	 
 
SetDefaultPageSize
òò
 
(
òò 
iText
òò "
.
òò" #
Kernel
òò# )
.
òò) *
Geom
òò* .
.
òò. /
PageSize
òò/ 7
.
òò7 8
A4
òò8 :
.
òò: ;
Rotate
òò; A
(
òòA B
)
òòB C
)
òòC D
;
òòD E!
ConverterProperties
ôô 

properties
ôô $
=
ôô% &
new
ôô' *!
ConverterProperties
ôô+ >
(
ôô> ?
)
ôô? @
;
ôô@ A
HtmlConverter
öö 
.
öö 
ConvertToPdf
öö  
(
öö  !

htmlString
öö! +
,
öö+ ,
pdf
öö- 0
,
öö0 1

properties
öö2 <
)
öö< =
;
öö= >
}
õõ 
}
úú 
}
ùù 
catch
ûû 
(
ûû	 

	Exception
ûû
 
ex
ûû 
)
ûû 
{
üü 
_logger
†† 
.
†† 
LogError
†† 
(
†† 
ex
†† 
,
†† 
$str
†† 3
)
††3 4
;
††4 5
throw
°° 	
;
°°	 

}
¢¢ 
return
§§ 	
pdfPath
§§
 
;
§§ 
}
•• 
private
ßß 	
static
ßß
 
void
ßß 
SendEmailWithPdf
ßß &
(
ßß& '
string
ßß' -
connectionString
ßß. >
,
ßß> ?
string
ßß@ F
pdfPath
ßßG N
)
ßßN O
{
®® 
try
©© 
{
™™ 
using
´´ 	
(
´´
 
var
´´ 

connection
´´ 
=
´´ 
new
´´ 
SqlConnection
´´  -
(
´´- .
connectionString
´´. >
)
´´> ?
)
´´? @
{
¨¨ 

connection
≠≠ 
.
≠≠ 
Open
≠≠ 
(
≠≠ 
)
≠≠ 
;
≠≠ 
using
ÆÆ 

(
ÆÆ 
var
ÆÆ 
command
ÆÆ 
=
ÆÆ 
new
ÆÆ 

SqlCommand
ÆÆ (
(
ÆÆ( )
$str
ÆÆ) E
,
ÆÆE F

connection
ÆÆG Q
)
ÆÆQ R
)
ÆÆR S
{
ØØ 
command
∞∞ 
.
∞∞ 
CommandType
∞∞ 
=
∞∞ 
CommandType
∞∞ '
.
∞∞' (
StoredProcedure
∞∞( 7
;
∞∞7 8
command
±± 
.
±± 

Parameters
±± 
.
±± 
AddWithValue
±± %
(
±±% &
$str
±±& .
,
±±. /
$num
±±0 1
)
±±1 2
;
±±2 3
command
≤≤ 
.
≤≤ 

Parameters
≤≤ 
.
≤≤ 
AddWithValue
≤≤ %
(
≤≤% &
$str
≤≤& 4
,
≤≤4 5
Path
≤≤6 :
.
≤≤: ;)
GetFileNameWithoutExtension
≤≤; V
(
≤≤V W
pdfPath
≤≤W ^
)
≤≤^ _
)
≤≤_ `
;
≤≤` a
command
≥≥ 
.
≥≥ 
ExecuteNonQuery
≥≥ 
(
≥≥ 
)
≥≥ 
;
≥≥  
}
¥¥ 
}
µµ 
}
∂∂ 
catch
∑∑ 
(
∑∑	 

SqlException
∑∑
 
ex
∑∑ 
)
∑∑ 
{
∏∏ 
_logger
ππ 
.
ππ 
LogError
ππ 
(
ππ 
ex
ππ 
,
ππ 
$str
ππ >
)
ππ> ?
;
ππ? @
throw
∫∫ 	
;
∫∫	 

}
ªª 
}
ºº 
private
ææ 	
static
ææ
 
string
ææ 
DetermineShift
ææ &
(
ææ& '
)
ææ' (
{
øø 
var
¿¿ 
currentHour
¿¿ 
=
¿¿ 
DateTime
¿¿ 
.
¿¿ 
Now
¿¿ !
.
¿¿! "
	TimeOfDay
¿¿" +
;
¿¿+ ,
if
¡¡ 
(
¡¡ 
currentHour
¡¡ 
<
¡¡ 
new
¡¡ 
TimeSpan
¡¡ !
(
¡¡! "
$num
¡¡" #
,
¡¡# $
$num
¡¡% &
,
¡¡& '
$num
¡¡( )
)
¡¡) *
)
¡¡* +
{
¬¬ 
return
√√ 

$str
√√ 
;
√√ 
}
ƒƒ 
else
≈≈ 
if
≈≈ 

(
≈≈ 
currentHour
≈≈ 
<
≈≈ 
new
≈≈ 
TimeSpan
≈≈ &
(
≈≈& '
$num
≈≈' )
,
≈≈) *
$num
≈≈+ ,
,
≈≈, -
$num
≈≈. /
)
≈≈/ 0
)
≈≈0 1
{
∆∆ 
return
«« 

$str
«« 
;
«« 
}
»» 
else
…… 
{
   
return
ÀÀ 

$str
ÀÀ 
;
ÀÀ 
}
ÃÃ 
}
ÕÕ 
private
œœ 	
static
œœ
 
void
œœ 
ConfigureServices
œœ '
(
œœ' (
)
œœ( )
{
–– 
var
—— 
appDirectory
—— 
=
—— 
	AppDomain
—— 
.
——  
CurrentDomain
——  -
.
——- .
BaseDirectory
——. ;
;
——; <
var
““ 
builder
““ 
=
““ 
new
““ "
ConfigurationBuilder
““ )
(
““) *
)
““* +
.
””
 
SetBasePath
”” 
(
”” 
appDirectory
”” #
)
””# $
.
‘‘
 
AddJsonFile
‘‘ 
(
‘‘ 
$str
‘‘ )
,
‘‘) *
optional
‘‘+ 3
:
‘‘3 4
false
‘‘5 :
,
‘‘: ;
reloadOnChange
‘‘< J
:
‘‘J K
true
‘‘L P
)
‘‘P Q
;
‘‘Q R
_configuration
’’ 
=
’’ 
builder
’’ 
.
’’ 
Build
’’ !
(
’’! "
)
’’" #
;
’’# $
var
◊◊ 
serviceCollection
◊◊ 
=
◊◊ 
new
◊◊ 
ServiceCollection
◊◊ 0
(
◊◊0 1
)
◊◊1 2
;
◊◊2 3
serviceCollection
ÿÿ 
.
ÿÿ 

AddLogging
ÿÿ 
(
ÿÿ  
	configure
ÿÿ  )
=>
ÿÿ* ,
{
ŸŸ 
	configure
⁄⁄ 
.
⁄⁄ 
AddConfiguration
⁄⁄ 
(
⁄⁄ 
_configuration
⁄⁄ -
.
⁄⁄- .

GetSection
⁄⁄. 8
(
⁄⁄8 9
$str
⁄⁄9 B
)
⁄⁄B C
)
⁄⁄C D
;
⁄⁄D E
	configure
€€ 
.
€€ 

AddConsole
€€ 
(
€€ 
)
€€ 
;
€€ 
var
‹‹ 
logFilePath
‹‹ 
=
‹‹ 
_configuration
‹‹ $
[
‹‹$ %
$str
‹‹% 3
]
‹‹3 4
;
‹‹4 5
if
›› 
(
›› 
!
›› 	
string
››	 
.
›› 
IsNullOrEmpty
›› 
(
›› 
logFilePath
›› )
)
››) *
)
››* +
{
ﬁﬁ 
	configure
ﬂﬂ 
.
ﬂﬂ 
AddProvider
ﬂﬂ 
(
ﬂﬂ 
new
ﬂﬂ  
FileLoggerProvider
ﬂﬂ 1
(
ﬂﬂ1 2
logFilePath
ﬂﬂ2 =
)
ﬂﬂ= >
)
ﬂﬂ> ?
;
ﬂﬂ? @
}
‡‡ 
}
·· 
)
·· 
;
·· 
var
„„ 
serviceProvider
„„ 
=
„„ 
serviceCollection
„„ *
.
„„* +"
BuildServiceProvider
„„+ ?
(
„„? @
)
„„@ A
;
„„A B
_logger
‰‰ 

=
‰‰ 
serviceProvider
‰‰ 
.
‰‰ 

GetService
‰‰ '
<
‰‰' (
ILogger
‰‰( /
<
‰‰/ 0
Program
‰‰0 7
>
‰‰7 8
>
‰‰8 9
(
‰‰9 :
)
‰‰: ;
;
‰‰; <
}
ÂÂ 
}
ÊÊ 
}ÁÁ æ
^D:\CLINICA\nsp-csfl-agenda-uti-automatizacion_qa\GeneracionReporteDietas\FileLoggerProvider.cs
	namespace 	#
GeneracionReporteDietas
 !
{ 
public 
class 
FileLoggerProvider  
:! "
ILoggerProvider# 2
{ 
private 	
readonly
 
string 
path 
; 
public 
FileLoggerProvider	 
( 
string "
path# '
)' (
{		 
this

 
.

 
path

 
=

 
path

 
;

 
} 
public 
ILogger	 
CreateLogger 
( 
string $
categoryName% 1
)1 2
{ 
return 	
new
 

FileLogger 
( 
path 
) 
; 
} 
public 
void	 
Dispose 
( 
) 
{ 
} 
} 
} «
VD:\CLINICA\nsp-csfl-agenda-uti-automatizacion_qa\GeneracionReporteDietas\FileLogger.cs
	namespace 	#
GeneracionReporteDietas
 !
{ 
public 
class 

FileLogger 
: 
ILogger "
{ 
private 	
readonly
 
string 
filePath "
;" #
public

 

FileLogger

	 
(

 
string

 
path

 
)

  
{ 
filePath 
= 
path 
; 
} 
public 
IDisposable	 

BeginScope 
<  
TState  &
>& '
(' (
TState( .
state/ 4
)4 5
=>6 8
null9 =
;= >
public 
bool	 
	IsEnabled 
( 
LogLevel  
logLevel! )
)) *
=>+ -
true. 2
;2 3
public 
void	 
Log 
< 
TState 
> 
( 
LogLevel "
logLevel# +
,+ ,
EventId- 4
eventId5 <
,< =
TState> D
stateE J
,J K
	ExceptionL U
	exceptionV _
,_ `
Funca e
<e f
TStatef l
,l m
	Exceptionn w
,w x
stringy 
>	 Ä
	formatter
Å ä
)
ä ã
{ 
if 
( 
! 
	IsEnabled 
( 
logLevel 
) 
) 
{ 
return 

;
 
} 
var 
message 
= 
	formatter 
( 
state  
,  !
	exception" +
)+ ,
;, -
if 
( 
string 
. 
IsNullOrEmpty 
( 
message #
)# $
)$ %
{ 
return 

;
 
} 
message   

=   
$"   
{   
DateTime   
.   
Now   
:   
$str   
}   
$str   !
{  ! "
logLevel  " *
}  * +
$str  + -
{  - .
message  . 5
}  5 6
$str  6 7
{  7 8
	exception  8 A
}  A B
"  B C
;  C D
try"" 
{## 
File$$ 
.$$ 	
AppendAllText$$	 
($$ 
filePath$$ 
,$$  
message$$! (
+$$) *
Environment$$+ 6
.$$6 7
NewLine$$7 >
)$$> ?
;$$? @
}%% 
catch&& 
(&&	 

	Exception&&
 
ex&& 
)&& 
{'' 
}(( 
})) 
}** 
}-- 